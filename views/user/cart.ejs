<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fontawesome-iconpicker/3.2.0/js/fontawesome-iconpicker.min.js"> -->
  <!-- <link rel="stylesheet" href="/styles/style.css"> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.11.0/mdb.min.css" />

</head>

<body>
  <header>
    <!-- Jumbotron -->
    <div class="p-3 text-center bg-white border-bottom">
      <div class="container">
        <div class="row gy-3">
          <!-- Left elements -->
          <div class="col-lg-2 col-sm-4 col-4">
            <h3 class="text text-primary">e_Shopee</h3>
          </div>
          <!-- Left elements -->

          <!-- Center elements -->
          <div class="order-lg-last col-lg-5 col-sm-8 col-8">
            <div class="d-flex float-end">

              <a href="/user/wishlist" class="me-1 border rounded py-1 px-3 nav-link d-flex align-items-center"
                target="_blank">
                <i class="fas fa-heart m-1 me-md-2"></i>
                <p class="d-none d-md-block mb-0">Wishlist</p>
              </a>

            </div>
          </div>
          <!-- Center elements -->

          <!-- Right elements -->
          <div class="col-lg-5 col-md-12 col-12">
            <div class="input-group float-center">
          
            </div>
          </div>
          <!-- Right elements -->
        </div>
      </div>
    </div>
    <!-- Jumbotron -->

    <!-- Heading -->
    <div class="bg-black">
      <div class="container py-4">
        <!-- Breadcrumb -->
        <nav class="d-flex">
          <h6 class="mb-0">
            <a href="/" class="text-white-50">Home</a>
            <span class="text-white-50 mx-2"> > </span>
            <a href="/user/productlists" class="text-white-50">product details</a>
            <span class="text-white-50 mx-2"> > </span>
            <a href="/user/cart" class="text-white"><u> cart</u></a>
          </h6>
        </nav>
        <!-- Breadcrumb -->
      </div>
    </div>
    <!-- Heading -->
  </header>


  <!-- Your cart contents here -->

  <div>
    <h2 class="container py-4">Your Cart</h2>
  </div>

  <section class="bg-light my-5">
    <div class="container">
      <div class="row">
        <!-- cart -->


        <div class="col-lg-9">


          <% cartData.items.forEach((cart)=> { %>
            <div class="card border shadow-0">
              <div class="m-4">
                <div class="row gy-3 mt-4">
                  <div class="col-lg-5">
                    <div class="me-lg-5">
                      <div class="d-flex">
                        <img src="/images/img/<%= cart.image %>" class="border rounded me-3"
                          style="width: 96px; height: 96px;" />
                        <div class="">
                          <a href="/user/productpage/<%=cart.productId %>" class="nav-link">
                            <%= cart.name %>
                          </a>
                          <p class="text-muted">
                            <%= cart.category %>
                          </p>
                          <h4>&#8377; <%= cart.price %>
                          </h4>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="col-lg col-sm-6 d-flex justify-content-sm-center justify-content-md-start justify-content-lg-center justify-content-xl-end mb-2">
                    <div class="cart__quantity">
                      <div style="margin-left: 20px;" class="container mt-5 pb-5">
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <div class="qty-container">
                              <button id="minus_<%= cart._id %>" class="btn btn-link px-2 qty-btn-minus " type="button"
                                data-index="<%= cart._id %>" data-user-id="<%= cart.userId %>"
                                data-product-id="<%= cart.productId %>"><i class="fas fa-minus"></i></button>
                                
                              <input style="width: auto;" min="1" type="number" id="quantity_<%= cart._id %>" name="qty"
                                value="<%= cart.quantity %>" readonly
                                class="input-qty form-control form-control-sm input-qty input-rounded" />

                              <button id="plus_<%= cart._id %>" class="btn btn-link px-2 qty-btn-plus" type="button"
                                data-index="<%= cart._id %>" data-user-id="<%= cart.userId %>"
                                data-product-id="<%= cart.productId %>"><i class="fas fa-plus"></i></button>
                              <div style="color: red;" id="outofstock_<%= cart.productId %>"></div>
                            </div>
                          </div>
                        </div>

                      </div>
                    </div>


                  </div>
                  <div
                    class="col-lg col-sm-6 d-flex justify-content-sm-center justify-content-md-start justify-content-lg-center justify-content-xl-end mb-2">
                    <div class="float-md-end">
                      <!-- <a href="#" class="btn btn-light border px-2 icon-hover-primary"><i class="fas fa-heart fa-lg px-1 text-secondary"></i></a> -->
                      <a href="/user/removeproduct/<%= cart._id %>"
                        class="btn btn-light border text-danger icon-hover-danger"> Remove</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <% }) %>

        </div>
        <!-- cart -->


        <!-- summary -->
        <div class="col-lg-3">
          <div class="card shadow-0 border">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <p class="mb-2">Total price:</p>
                <p id="total" class="mb-2 total-price">
                  <%= totalPrice %>
                </p>
              </div>
              <div id="e"></div>

              <hr />
              <div class="d-flex justify-content-between">
                <p class="mb-2">Total price:</p>
                <p class="mb-2 fw-bold grand-total">
                  <%= totalPrice %>
                </p>
              </div>

              <div class="mt-3">

                <a href="/user/checkout" class="btn btn-success w-100 shadow-0 mb-2"> Proceed to checkout </a>
                <a href="/user/login" class="btn btn-light w-100 border mt-2"> Back to shop </a>
              </div>
            </div>
          </div>
        </div>
        <!-- summary -->
      </div>
    </div>
  </section>
  <!-- cart + summary -->





  <!-- cart + summary -->

  <!-- cart + summary -->

  <!-- Recommended -->

  <!-- Footer -->
  <footer class="text-center text-white mt-4" style="background-color:rgb(19, 1, 1)">



    <div class="container text-center justify-content-center pt-4 pb-4 ps-5 ">
      <!-- Grid row -->
      <div class="row mt-3">
        <!-- Grid column -->
        <div class="col-12 col-lg-3 col-sm-12 mb-2">
          <!-- Content -->
          <a href="/" target="_blank" class="text-white h2">
            <h3 class="text text-primary">e_Shopee</h3>
          </a>
          <p class="mt-1 text-white">
            Experiance the feel of SHopping
          </p>
        </div>
        <!-- Grid column -->

        <!-- Grid column -->
        <div class="col-6 col-sm-4 col-lg-2">
          <!-- Links -->
          <h6 class="text-uppercase text-white fw-bold mb-2 ">
            Store
          </h6>
          <ul class="list-unstyled mb-4">
            <li><a class="text-white-50" href="/">Home</a></li>
            <li><a class="text-white-50" href="#">About us</a></li>
            <li><a class="text-white-50" href="/user/productlists">Find store</a></li>
            <li><a class="text-white-50" href="/user/productlists">Categories</a></li>

          </ul>
        </div>
        <!-- Grid column -->

        <!-- Grid column -->
        <div class="col-6 col-sm-4 col-lg-2">
          <!-- Links -->
          <h6 class="text-uppercase text-white fw-bold mb-2">
            Information
          </h6>
          <ul class="list-unstyled mb-4">
            <li><a class="text-white-50" href="#">Help center</a></li>
            <li><a class="text-white-50" href="#">Money refund</a></li>
            <li><a class="text-white-50" href="#">Shipping info</a></li>
            <li><a class="text-white-50" href="#">Refunds</a></li>
          </ul>
        </div>

        <!--Call to action-->

        <!--/.Call to action-->


        </section>
        <!-- Section: Social media -->
      </div>
      <!-- Grid container -->



  </footer>
  <!-- Footer -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      ;
      const buttons = document.querySelectorAll('.qty-btn-minus, .qty-btn-plus');

      buttons.forEach(button => {
        button.addEventListener('click', () => {
          const productId = button.getAttribute("data-product-id");
          const userId = button.getAttribute("data-user-id");
          const cartId = button.getAttribute('data-index');
          const quantityInput = document.getElementById(`quantity_${cartId}`);
          const outOfStockMessage = document.getElementById(`outofstock_${cartId}`);
          let currentValue = parseInt(quantityInput.value);

          if (button.classList.contains('qty-btn-minus')) {
            currentValue = Math.max(currentValue - 1, 1);
          } else {
            currentValue += 1;
          }

          quantityInput.value = currentValue;
          // outOfStockMessage.textContent = ''; // Clear out-of-stock message

          console.log(currentValue, cartId, productId);
          sendQuantityToServer(cartId, currentValue, productId);
        });
      });

      function sendQuantityToServer(cartId, currentValue, productId) {
        fetch(`/product/cart/update/${cartId}/${currentValue}/${productId}`, {
          method: "post",
          headers: { "content-Type": 'application/json' },
          body: JSON.stringify({ currentValue, cartId })
        })
          .then(response => response.json())
          .then(data => {
            console.log(data);
            const productId = data.data; // Make sure to get the correct attribute name
            const quantityInput = document.getElementById(`quantityInput_${productId}`);
            // const outOfStockMessage = document.getElementById(`outofstock_${productId}`);
            const plusbtn = document.getElementById(`plus_${cartId}`);

            if (data.message === 'Out Of Stock') {

              document.getElementById(`outofstock_${productId}`).innerHTML = 'Out of stock';
              // outOfStockMessage.innerHTML = 'Out of stock';
              plusbtn.style.display = 'none';
            }
            else if (data.message == 'successfully') {
              const total = data.grandTotal
              console.log("data", data)

              document.getElementById('total').textContent = total;
              console.log("total", total)


              document.querySelectorAll('.grand-total').forEach(element => {
                element.innerHTML = total;
              });
              plusbtn.style.display = 'block'
              document.getElementById(`outofstock_${productId}`).innerHTML = ''
              // outOfStockMessage.innerHTML = '';
            }
            else {
              quantityInput.value = data.quantity;
              plusbtn.style.display = 'block';
            }
          })
          .catch(error => {
            document.getElementById(`outofstock_${productId}`).innerHTML = ''
            console.error('Error updating quantity:', error);
          });
      }
    });

  </script>


</body>

</html>